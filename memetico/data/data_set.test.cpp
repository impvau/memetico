
#include "doctest.h"
#include <memetico/data/data_set.h>
#include <sstream>
#include <fstream>

TEST_CASE("DataSet: ") {

    // Tests
    // 1. Create DataSet given file
    string file_name = "test_data.csv";
    DataSet ds = DataSet(file_name);
    REQUIRE(ds.get_file() == file_name);

}

TEST_CASE("load() ") {

    // Tests
    // 1. Load dataset that doesnt exist
    // 2. Load basic datset
    // 3. Load dataset with uncertainty, weights etc.
    // Todo
    // Special character issues in file and filename
    // Load dataset missing y
    // Load dataset missing varaibles

    // 1. Load dataset that doesnt exist
    string fn1("Non-existing-file.csv");
    DataSet ds1 = DataSet(fn1);
    try {
        ds1.load();
    } catch (const exception& ex) {
        stringstream ss; 
        ss << ex.what();
        REQUIRE(ss.str() == "Unable to open file "+ fn1);
        // Weird -- need to reset errno else some other test in a random part of the application
        // throws an error with "No such file or directory"
        errno = 0;
    }

    // 2. Load basic datset
    string fn2("test_data.csv");
    ofstream f;
    f.open(fn2);
    if (!f.is_open())
        throw runtime_error("Unable to open file "+ fn2);
    f << "y,x1,x2,x3,x4,x5,x6" << endl;
    f << "5,10.4,335,123,356,12.4,16.2" << endl;
    f << "6,11.4,336,124,357,12.5,16.3" << endl;
    f.close();
    DataSet ds = DataSet(fn2);
    //
    ds.load();
    // 2.1 Check basic values
    REQUIRE( ds.get_file() == "test_data.csv" );
    REQUIRE( !ds.has_uncertainty() );
    REQUIRE( !ds.has_weight() );
    REQUIRE( !ds.has_derivative() );
    REQUIRE( ds.get_count() == 2 );
    REQUIRE( ds.weight.size() == 0 );
    REQUIRE( ds.dy.size() == 0 );
    REQUIRE( ds.y.size() == 2 );
    REQUIRE( ds.y[0] == 5 );
    REQUIRE( ds.samples.size() == 2 );
    REQUIRE( ds.samples[0].size() == 6 );
    // 2.2 Check saved samples
    REQUIRE( float(ds.samples[0][0]) == float(10.4) );
    REQUIRE( float(ds.samples[0][1]) == float(335) );
    REQUIRE( float(ds.samples[0][2]) == float(123) );
    REQUIRE( float(ds.samples[0][3]) == float(356) );
    REQUIRE( float(ds.samples[0][4]) == float(12.4) );
    REQUIRE( float(ds.samples[0][5]) == float(16.2) );
    REQUIRE( float(ds.samples[1][0]) == float(11.4) );
    REQUIRE( float(ds.samples[1][1]) == float(336) );
    REQUIRE( float(ds.samples[1][2]) == float(124) );
    REQUIRE( float(ds.samples[1][3]) == float(357) );
    REQUIRE( float(ds.samples[1][4]) == float(12.5) );
    REQUIRE( float(ds.samples[1][5]) == float(16.3) );
    // 2.3 Check varaibles 
    REQUIRE( DataSet::IVS.size() == 6 );
    REQUIRE( DataSet::IVS[0] == "x1" );
    REQUIRE( DataSet::IVS[1] == "x2" );
    REQUIRE( DataSet::IVS[2] == "x3" );
    REQUIRE( DataSet::IVS[3] == "x4" );
    REQUIRE( DataSet::IVS[4] == "x5" );
    REQUIRE( DataSet::IVS[5] == "x6" );
    
    // 3. Load dataset with uncertainty, weights etc.
    string fn3("test_data.csv");
    ofstream f3;
    f3.open(fn3);
    if (!f3.is_open())
        throw runtime_error("Unable to open file "+ fn3);
    f3 << "y,yd,ydd,yddd,x1,x2,x3,x4,x5,x6,dy,w" << endl;
    f3 << "5,8,5,7,10.4,335,123,356,12.4,16.2,0.1,1.1" << endl;
    f3 << "6,6,2,6,11.4,336,124,357,12.5,16.3,0.2,1.2" << endl;
    f3 << "7,5,8,4,12.4,337,125,358,12.6,16.4,0.3,1.3" << endl;
    f3 << "8,4,8,9,13.4,338,126,359,12.7,16.5,0.4,1.4" << endl;
    f3.close();
    DataSet ds3 = DataSet(fn3);
    //
    ds3.load();
    // 3.1 Check basic values
    REQUIRE( ds3.get_file() == "test_data.csv" );
    REQUIRE( ds3.has_uncertainty() );
    REQUIRE( ds3.has_weight() );
    REQUIRE( ds3.has_derivative() );
    REQUIRE( ds3.get_count() == 4 );
    // 0th Derviative
    REQUIRE( ds3.Yder[0].size() == 4 );
    REQUIRE( float(ds3.Yder[0][0]) == float(8));
    REQUIRE( float(ds3.Yder[0][1]) == float(6));
    REQUIRE( float(ds3.Yder[0][2]) == float(5));
    REQUIRE( float(ds3.Yder[0][3]) == float(4));
    // 1st Derviative
    REQUIRE( ds3.Yder[1].size() == 4 );
    REQUIRE( float(ds3.Yder[1][0]) == float(5));
    REQUIRE( float(ds3.Yder[1][1]) == float(2));
    REQUIRE( float(ds3.Yder[1][2]) == float(8));
    REQUIRE( float(ds3.Yder[1][3]) == float(8));
    // 2nd Derviative
    REQUIRE( ds3.Yder[2].size() == 4 );
    REQUIRE( float(ds3.Yder[2][0]) == float(7));
    REQUIRE( float(ds3.Yder[2][1]) == float(6));
    REQUIRE( float(ds3.Yder[2][2]) == float(4));
    REQUIRE( float(ds3.Yder[2][3]) == float(9));
    // Weight
    REQUIRE( ds3.weight.size() == 4 );
    REQUIRE( float(ds3.weight[0]) == float(1.1));
    REQUIRE( float(ds3.weight[1]) == float(1.2));
    REQUIRE( float(ds3.weight[2]) == float(1.3));
    REQUIRE( float(ds3.weight[3]) == float(1.4));
    // Uncertainty
    REQUIRE( ds3.dy.size() == 4 );
    REQUIRE( float(ds3.dy[0]) == float(0.1));
    REQUIRE( float(ds3.dy[1]) == float(0.2));
    REQUIRE( float(ds3.dy[2]) == float(0.3));
    REQUIRE( float(ds3.dy[3]) == float(0.4));
    // 3.1 Check target
    REQUIRE( ds3.y.size() == 4 );
    REQUIRE( float(ds3.y[0]) == float(5));
    REQUIRE( float(ds3.y[1]) == float(6));
    REQUIRE( float(ds3.y[2]) == float(7));
    REQUIRE( float(ds3.y[3]) == float(8));
    // 3.2 Check saved samples
    REQUIRE( ds3.samples.size() == 4 );
    REQUIRE( ds3.samples[0].size() == 6 );
    REQUIRE( float(ds3.samples[0][0]) == float(10.4) );
    REQUIRE( float(ds3.samples[0][1]) == float(335) );
    REQUIRE( float(ds3.samples[0][2]) == float(123) );
    REQUIRE( float(ds3.samples[0][3]) == float(356) );
    REQUIRE( float(ds3.samples[0][4]) == float(12.4) );
    REQUIRE( float(ds3.samples[0][5]) == float(16.2) );
    REQUIRE( float(ds3.samples[1][0]) == float(11.4) );
    REQUIRE( float(ds3.samples[1][1]) == float(336) );
    REQUIRE( float(ds3.samples[1][2]) == float(124) );
    REQUIRE( float(ds3.samples[1][3]) == float(357) );
    REQUIRE( float(ds3.samples[1][4]) == float(12.5) );
    REQUIRE( float(ds3.samples[1][5]) == float(16.3) );
    REQUIRE( float(ds3.samples[2][0]) == float(12.4) );
    REQUIRE( float(ds3.samples[2][1]) == float(337) );
    REQUIRE( float(ds3.samples[2][2]) == float(125) );
    REQUIRE( float(ds3.samples[2][3]) == float(358) );
    REQUIRE( float(ds3.samples[2][4]) == float(12.6) );
    REQUIRE( float(ds3.samples[2][5]) == float(16.4) );
    REQUIRE( float(ds3.samples[3][0]) == float(13.4) );
    REQUIRE( float(ds3.samples[3][1]) == float(338) );
    REQUIRE( float(ds3.samples[3][2]) == float(126) );
    REQUIRE( float(ds3.samples[3][3]) == float(359) );
    REQUIRE( float(ds3.samples[3][4]) == float(12.7) );
    REQUIRE( float(ds3.samples[3][5]) == float(16.5) );
    REQUIRE( DataSet::IVS.size() == 6 );
    REQUIRE( DataSet::IVS[0] == "x1" );
    REQUIRE( DataSet::IVS[1] == "x2" );
    REQUIRE( DataSet::IVS[2] == "x3" );
    REQUIRE( DataSet::IVS[3] == "x4" );
    REQUIRE( DataSet::IVS[4] == "x5" );
    REQUIRE( DataSet::IVS[5] == "x6" );

}

TEST_CASE(" normalise() ") {

    // Load data with known derivative
    string fn("test_data.csv");
    ofstream f;
    f.open(fn);
    if (!f.is_open())
        throw runtime_error("Unable to open file "+ fn);

    // Write the header
    f << "y,x,yd,ydd,yddd" << endl;
    // In excel, we can use the following to build the string =CONCAT("f << """, A2,",",B2,",",C2,",",D2,",",E2, """ << endl;")
    f << "5.75216507131031,1.21158951655157,10.8875116049814,-35.9178834085914,-236.674781097529" << endl;
    f << "4.31876937084382,1.09085004307293,11.0914295334206,49.6796889215656,-1004.86316962461" << endl;
    f << "0.791051499652717,-0.0935787053174586,-11.9348760855023,46.7907095812802,1008.00838101071" << endl;
    f << "4.089846246331,-0.842193654338596,5.71024766614384,-11.1130765680727,-697.016939466085" << endl;
    f << "4.40163201152561,0.545253611780536,2.91176339062732,-16.4183106806287,-52.0376335321454" << endl;
    f << "1.01131941732619,0.111486736514683,12.6113132948914,28.814407162849,-988.298435902323" << endl;
    f << "3.5744740824253,-0.969148927003456,-0.066196622253277,98.7825398776912,-498.141776467768" << endl;
    f << "6.66134126727409,1.92749363654414,-4.06547437117131,67.7211387195838,937.870694842906" << endl;
    f << "2.01832591352253,0.189945085368035,12.294206214335,-29.0634000159769,-413.536089704494" << endl;
    f << "2.64659581116728,-0.245374049466792,-10.2741714732946,-40.1887819110067,22.31777436336" << endl;
    f << "0.301279517696837,-0.0468855171793256,-8.71256345849655,88.9028513624401,709.87270356924" << endl;
    f << "7.76176621204807,1.6904830763928,-1.20659609345089,-34.3203334442766,-154.116757374445" << endl;
    f << "6.53051592630377,1.29568605898916,7.62706609006378,-36.3983644028355,137.998770768416" << endl;
    f << "3.17725647996686,-0.303514063827696,-8.02885450785697,-35.4116370851457,-148.462713791342" << endl;
    f << "3.66255853785587,-0.923923424750924,3.69848861082895,64.2165472698516,-957.347207270611" << endl;
    f << "3.97349407991919,-0.432475147934399,-4.70830227291854,-17.8857472901093,-78.279503960007" << endl;
    f << "3.77708126936715,0.393785440500935,5.47000179001202,-21.7711691915784,121.895515245991" << endl;
    f << "2.21510186985684,0.206288811455618,11.7701573967522,-34.6945848068096,-277.651358207407" << endl;
    f << "4.31855928305068,-0.518668497696744,-3.333489263484,-15.444404957671,21.2870043754433" << endl;
    f << "4.36171509419283,-0.532031287123978,-3.12475029417214,-15.8317466352207,36.6999885841963" << endl;
    f << "3.68168885489813,-0.376930050154756,-5.85509787318969,-23.9699857399523,-138.617976448303" << endl;
    f << "7.18947870784785,1.40699979666044,4.52414556776652,-20.120924117686,107.473921126525" << endl;
    f << "4.60874843856141,0.676494724521009,-0.108582952169211,-32.2283080597495,-161.738342931552" << endl;
    f << "0.906008891222665,-0.103046987893211,-12.3326760062058,37.2403375442781,1006.03638667734" << endl;
    f << "4.137937541056,0.833689161519814,-5.59141364396234,-16.7282605555855,623.082706126629" << endl;
    f << "3.84173438767475,0.885683507823483,-5.42866030480415,26.1420212666358,979.523868305897" << endl;
    f << "3.67423578346107,-0.920847025073935,3.89149066763942,61.248812032798,-971.625972053372" << endl;
    f << "6.93959153945441,1.87576570883048,-6.24897029282644,16.7481590093378,936.568300338183" << endl;
    f << "3.66382801608767,0.92358119735608,-3.72040917708884,63.8886247794099,959.049223362592" << endl;
    f << "6.57210111500203,1.98998950891102,1.61522219816047,105.929208438714,168.883112960017" << endl;
    f << "0.801584151504194,0.0944597038442665,11.9757073535784,45.902352154531,-1008.66793544248" << endl;
    f << "4.4118800915332,-0.777262017601174,3.91773331395273,-38.1599484483296,-156.775510722092" << endl;
    f << "5.34018429233882,1.17566018389698,11.9628796473273,-22.1197031922992,-539.683687313521" << endl;
    f << "6.65638414848365,1.31287819045099,7.02280857347798,-33.8421899349947,156.93911404326" << endl;
    f << "0.576041368797739,0.0747777262540694,10.8791676331259,65.3324071764651,-950.338049458613" << endl;
    f << "6.37429912004083,1.27613716078293,8.36271116988949,-38.728705009314,96.4900163587773" << endl;
    f << "3.5779985988974,-0.976908981345251,-0.84659689813977,102.198510798502,-380.934495728811" << endl;
    f << "3.74218191762642,-0.387485236755882,-5.60962732883914,-22.5598103104708,-128.413410984917" << endl;
    f << "3.84217185271994,0.405974097897088,5.21337147820434,-20.3654535042625,108.645176345156" << endl;
    f << "4.10515419405547,0.462034438643417,4.20879417105232,-16.0809114427439,43.862493282991" << endl;
    f << "4.94076950528479,1.14296272627977,12.346408358231,0.177843294821222,-816.394744514316" << endl;
    f << "4.22258728335691,0.491566371303712,3.74805842934082,-15.2891755247542,9.81822493632518" << endl;
    f << "2.69783952002582,0.250411334593573,10.0715512144834,-40.2389439014152,2.06880983930634" << endl;
    f << "0.448657310144153,-0.0625974590212788,-10.0147334931953,76.439485426722,867.501816448262" << endl;
    f << "4.10971191551194,0.463119590368436,4.19136952054175,-16.0339966756938,42.6043479038701" << endl;
    f << "5.92149805852631,1.22757705294165,10.2879973859885,-38.7807990278552,-124.50476894601" << endl;
    f << "4.28572856226068,-0.80572152129487,4.912262330062,-30.6859856923646,-376.626296640075" << endl;
    f << "4.60530620418078,-0.6577630452412,-0.466611985796209,-29.1881530808044,161.057453552093" << endl;
    f << "4.16293436879655,-0.829186593079273,5.50991219836211,-19.4439772949013,-583.157728705626" << endl;
    f << "4.49894703594448,-0.751799162121505,2.91261552213449,-40.1590926623421,-8.67685557345618" << endl;
    f << "4.00289452989895,-0.438794704893315,-4.59678640048956,-17.4143158389072,-70.9159224174217" << endl;
    f << "3.31569518987312,-0.32144766812631,-7.41855348075094,-32.6121872352529,-161.394061118842" << endl;
    f << "2.94620433825848,-0.276413371582682,-9.03809820884115,-38.8391650611293,-97.2732011035598" << endl;
    f << "0.302469303664115,0.0470219820062949,8.72468895590559,88.8058695987122,-711.471137356482" << endl;
    f << "4.19345052978551,-0.483912276075844,-3.86545662988452,-15.3979564944258,-18.6086156943461" << endl;
    f << "3.69091955233745,-0.916692607242046,4.13751108578498,57.178330979337,-987.270976361419" << endl;
    f << "1.06781057321187,-0.115944590259083,-12.7299902120822,24.4406736711232,973.348950565515" << endl;
    f << "6.55983838130922,1.97249757494534,-0.19723158852848,100.487422171066,448.519141065872" << endl;
    f << "4.6807194194744,1.12178727264116,12.1486799622683,18.9652305400009,-948.446435462095" << endl;
    f << "7.45949914587949,1.47628535664651,3.32432598150143,-15.4415060400468,27.3609042007943" << endl;
    f << "0.514788467225795,0.0690460728070796,10.4892729342342,70.6842419089335,-915.801880892209" << endl;
    f << "0.468912678003718,-0.0646047561879912,-10.1664116002032,74.6818385083388,883.596972782418" << endl;
    f << "7.44479544837818,1.79192011222158,-5.07540795516513,-34.9709234738154,263.868376629003" << endl;
    f << "7.77936529695484,1.67026194822142,-0.544973242414788,-31.0895951523097,-162.762864175309" << endl;
    f << "3.87778163924129,1.0449831458812,7.82358327698808,90.3755576403501,-687.227830850747" << endl;
    f << "7.78247423404899,1.66312066241141,-0.327103705577505,-29.9277876929808,-162.355033094752" << endl;
    f << "3.71136951730625,0.911904088009247,-4.39993709932731,52.417710708948,1000.16589924583" << endl;
    f << "7.45812365389526,1.7892697170719,-4.98181844997095,-35.6431104328852,243.439846492017" << endl;
    f << "2.76963492116935,-0.257644314163112,-9.78084182617149,-40.1074285864942,-33.6217555330013" << endl;
    f << "4.60208817774286,-0.693533417307138,0.680830222436794,-34.9125272537386,151.299098168267" << endl;
    f << "4.50584176052727,-0.585961502778545,-2.18719796156207,-19.5009197415822,99.2668754149997" << endl;
    f << "7.17184579819227,1.40313571849982,4.60270745671554,-20.544520538221,111.764939736616" << endl;
    f << "4.13775631409942,1.07380526587664,10.1007332308871,66.3969061161282,-945.068086280396" << endl;
    f << "0.661413434271623,-0.0824547131294182,-11.3523522282848,57.8979050729595,984.108949307779" << endl;
    f << "3.86118478125898,0.88212966363449,-5.51540651175804,22.6841884796176,966.068347744925" << endl;
    f << "7.77859058506271,1.6716299961237,-0.587657579618167,-31.3121974955939,-162.657440631114" << endl;
    f << "4.51810953244601,0.591719680623202,2.07322641605038,-20.0913046965608,-105.777061914026" << endl;
    f << "0.0764013078899314,0.0157911986362662,5.67091590039564,104.416490771198,-264.059961534296" << endl;
    f << "4.19374016106317,0.48398721534971,3.86430277037719,-15.3965652061708,18.5224691179283" << endl;
    f << "7.74490501363322,1.70240163005216,-1.62631297607294,-36.0837172208712,-140.61048493674" << endl;
    f << "4.16591692778392,-0.476887872970988,-3.97414362176646,-15.5570531380264,-26.6928937029467" << endl;
    f << "1.65114679206734,-0.160916761564189,-12.9277040775496,-13.3378705187714,669.98919629096" << endl;
    f << "7.6373284318581,1.53871581427661,2.36702870368854,-15.9727323683232,-44.4691814587668" << endl;
    f << "6.66898435932855,1.31468017647391,6.96208088152284,-33.5583018892835,158.121207274022" << endl;
    f << "4.06795019160942,0.846015111719803,-5.74754749172586,-8.38766392362975,729.226481442513" << endl;
    f << "4.41615458802327,-0.550313750771967,-2.8279931175868,-16.6965273969846,57.9279794125431" << endl;
    f << "4.60556698673541,0.68749803026681,-0.47290878816836,-33.9831110294496,-156.412132385966" << endl;
    f << "4.98552094498343,1.1465878047206,12.3417488816327,-2.73179616076299,-788.694927127467" << endl;
    f << "1.9482522506765,-0.184282210854747,-12.4518944401306,-26.5817902492202,463.059840169585" << endl;
    f << "1.78170870880839,0.171078178897851,12.7591115929524,-19.6933764747571,-580.510698168963" << endl;
    f << "7.11803957964037,1.84773645484656,-6.37289706801967,-6.99773637501022,743.437891356334" << endl;
    f << "1.18170105374393,-0.124824364030686,-12.9091272906545,15.965952897748,933.240693371422" << endl;
    f << "7.09460810269681,1.38695679299381,4.95048813249449,-22.4935949680439,128.920381702128" << endl;
    f << "3.82373490789497,-0.889027194136539,5.33575329763218,29.4354632764644,-990.072983930931" << endl;
    f << "4.54678402730559,-0.606661846067897,-1.76059451328056,-21.7949108272171,122.077308035906" << endl;
    f << "4.41495004150881,1.0993685075258,11.4780637901204,41.0897922530504,-1009.17262489811" << endl;
    f << "4.58984321054962,0.706871577140042,-1.15950175861728,-36.8229580510482,-133.609923136567" << endl;
    f << "7.72441871979264,1.58222842353253,1.61393924951804,-19.0092257088344,-95.0272422862804" << endl;
    f << "7.66853039442702,1.73619749140369,-2.91367142930697,-39.6323190366537,-57.0715518975328" << endl;
    f << "4.47566355661086,0.759395782670583,-3.21707566709985,-39.94843053838,47.5448857354185" << endl;

    f.close();
    DataSet ds = DataSet(fn);
    ds.load();

    // 1. Finite difference test

    // Fornberg should be superior approximation to finite difference, so we define standard fd here to compare
    vector<vector<double>> fd = {
        { -1.43339570046649, 0.2039179284392, 85.597572330157, -768.188388527081 },
        { -2.4805567858288, -11.4111938452419, 41.3542964949358, 622.34158105412 },
        { -0.11446156225641, -2.69059093363838, -30.3963827448191, 153.923115079263 },
        { 1.80529025593645, 7.42331973806481, -31.6045101309544, -530.023007271428 },
        { -1.5392634145024, 3.45053281437378, 19.9637418654609, -145.640748218119 },
        { -0.413578964550155, -1.4889800064403, 57.6004252791599, -223.052071467811 },
        { 2.82501092497395, -8.33839383303135, 19.4533657783674, 963.084565372615 },
        { -0.778074084451385, 6.18020141829414, -63.9229699468341, 42.302843381637 },
        { -2.00737272805341, -3.10434855106165, -53.9549603152953, -457.776460239773 },
        { -0.858523197912846, -10.5033848364158, 58.9831256892085, 561.704396636867 },
        { 2.5575852004404, 4.53378768992185, 2.93422423336505, -88.2172658689025 },
        { 3.11461820430347, 8.16981477428017, -62.6506078826378, -285.936966400412 },
        { -2.29225486604061, -3.41112920720304, -0.54565182043455, 2.8270217915515 },
        { -1.43397869422395, -1.96428873961741, 50.3074558363436, -547.672989019513 },
        { 0.398118799976165, 1.66027611746921, 8.7629448975182, 35.0916049156675 },
        { 0.05726136575564, 0.885756589591535, -42.993858230715, 539.621361258301 },
        { -0.879196105031175, 8.23922983483537, -8.40441875835015, -99.6859271237 },
        { 0.270739006841765, -4.40174552674801, 3.1633821169537, -50.3042554352739 },
        { 1.07330661216799, -7.44745384546217, 9.43141908579445, 157.175673395802 },
        { -0.318435214076275, -1.26080430485285, -4.26279039114065, -79.9524904118732 },
        { 1.41388180682751, 3.82444793096933, -2.14458874123265, 35.3869662711644 },
        { 0.46352979183164, 2.87325746051024, -4.1291611598986, -11.5601832416245 },
        { -3.14173490831259, -8.42841078698616, 28.680630830982, 449.281232775407 },
        { -0.235405448752705, -2.74141534589656, 7.750023752082, 392.41052452909 },
        { 1.46786274822604, 3.45200785070082, -5.54915813882115, -13.2562591857215 },
        { -0.231850878797465, 4.74145215580088, 38.9885362941917, -797.354339090001 },
        { 1.54892857588983, -0.410154994011145, -4.696931128649, -21.477783983857 },
        { -0.00520388368670011, -3.80594992236413, 1.31990637330595, 965.337597707982 },
        { -0.18374521222619, 3.93209624549346, 44.5905247146881, -383.842593689083 },
        { -1.43112193229174, 7.84805826533362, -8.99313631243945, -983.858579402536 },
        { -1.08011051173442, 1.15125555789613, -72.0445784435218, -162.829311841055 },
        { 2.26930007041731, -0.00641385312554998, -34.0110276734151, 234.49212406448 },
        { 1.12225202847523, 1.55253762976262, 2.15887925666745, 156.857312382676 },
        { -2.38207146177054, -0.5418560071007, 43.7260551843821, -205.327181072546 },
        { -0.14104251422141, 0.669951298205755, -2.44325753715965, -30.2245488422413 },
        { 1.50097861504983, -5.86288226563284, 18.4330518110185, 284.701776864901 },
        { -1.31605860120721, -6.98616924936431, 8.0844473494216, -112.451713671847 },
        { 0.13208662691127, 3.02998418817205, -61.2819821513823, 244.789836036984 },
        { 0.181486138214525, 4.90921074994573, 3.23944943386345, 86.137952133954 },
        { 0.549298826282425, 3.56651844001333, 10.2716483995419, -462.519960429736 },
        { 0.0587165446507201, -0.23036787085575, 0.395867958994851, -17.0221341733329 },
        { -1.12146499262949, -1.1374285718738, -20.2083935981182, 409.231777176811 },
        { -1.88696498660638, -6.88139596126806, 45.8643304757381, 428.841795755968 },
        { 0.70593619774306, -2.94009084697082, 12.1024736128607, 20.2677690322819 },
        { 2.73642037419108, 10.1513654395919, -57.6101422272886, -496.003292697136 },
        { 0.0880083233743703, 0.360446404760125, -7.3259945083354, -209.615322271973 },
        { -0.658095927172765, -5.37730468589235, 4.7963229735254, 142.781111249051 },
        { -0.0613970967320654, 0.298824934150055, 5.62100419873165, -103.265716032776 },
        { -0.0531795841181504, 1.68961375396535, -5.48546979076885, -84.8671545627746 },
        { -0.0800199194487998, -5.05334929942584, 1.01483072799705, 256.120903144102 },
        { -0.59162592303568, -5.16558450144271, 3.7734527135446, -76.3586027726929 },
        { -0.528345095820235, -2.22065590417579, -10.7124246111111, -13.1786393430691 },
        { -1.5066129431045, 8.07162121832826, 60.7090284169825, -275.03853811882 },
        { 0.623623095763515, 2.58632078947832, 11.7206042833518, 39.3322927046069 },
        { 1.69422512433667, -2.2935889350603, -15.8137693096876, -137.899919502468 },
        { -1.56281997828682, -4.43226679109884, 19.9193150827745, 495.978783129931 },
        { 1.43445941448588, -2.16737133715673, 21.6545455958645, 717.895058713646 },
        { 1.80645442313127, 12.4393350871752, -2.73772156556115, -960.897693013805 },
        { 0.449830382285135, 1.76077878501495, -57.9644641055564, -210.579118432539 },
        { -2.0829654761243, -0.82970351401705, 25.8595056844663, 16.322277284943 },
        { -3.49529323393789, -6.74536879085231, 45.0616722741928, 428.118034290812 },
        { 3.46500349057619, -7.78234044469967, -52.8275826913744, 589.835128760606 },
        { 3.65522630947556, 4.81071917889421, -52.8857168303242, -523.179918478864 },
        { -1.78350690456845, 6.44949561607661, 62.6732405570827, -475.548103739875 },
        { 0.00155446854707497, 0.108934768418641, 0.580903729664449, 0.203915540278501 },
        { -0.0832060609675198, -6.1117601881577, -18.978923465701, 843.696865048288 },
        { -0.162175290076865, -2.32735737219672, -2.8576613699522, 202.897439793385 },
        { -0.47086729806845, -2.69045236342209, -46.2625696477211, -516.893827389416 },
        { -1.4280177380762, 2.83132433620387, 0.3652915895733, -46.070374161875 },
        { 0.86810341967896, 3.79682193230471, 10.303254422456, 66.4443154740005 },
        { 1.28487881022471, 1.96093861713937, 7.1840033577588, -19.7670792158255 },
        { -0.184042723213925, 6.14396559622458, 42.9489129288552, -522.167480847698 },
        { -3.25521618196032, -7.97752984250017, 39.2212128055903, 436.172004785581 },
        { -0.13828576642022, -7.80806987132257, -21.8563588182553, 955.56821701266 },
        { 3.55858857539554, 5.38234732433332, -44.6050512842767, -573.383194969447 },
        { 0.328462375593515, 3.79431646390421, -21.3877465880892, -535.922704829475 },
        { -3.85109463858639, 3.1292867400069, 67.8643441333959, -50.701260451591 },
        { -0.16218468569142, 0.895538177163405, 2.347369745195, 62.1497655159772 },
        { 3.83425185287164, -3.64861443823429, -70.2501039960346, 61.724738298778 },
        { -0.0139116166396249, -3.91922319607183, -0.0802439659278003, -22.6076814104375 },
        { -3.04687911078294, -5.65069555073833, 11.3729233510499, 405.29984061385 },
        { 1.73570575203709, 3.1705861627275, -0.2078396151484, -8.88814387791005 },
        { 2.50891878363061, 9.94489247953622, -10.110215685256, -255.933994508469 },
        { -1.78468912012434, -4.0572880977072, 3.79253422234672, 386.84783145064 },
        { -1.12641488565264, -4.89503699955482, 8.43088724614945, -50.0966139307395 },
        { 0.268808397562995, 2.63731935177875, -12.7977235529099, -442.81930691424 },
        { 0.28468317848008, 7.58487099960975, 6.9823656181108, -423.311453270005 },
        { -1.32865736802946, -5.98949282598112, 3.7006603901147, 309.735986277776 },
        { -1.60190611808752, 0.20868135565985, -8.48079015699705, 104.092114479252 },
        { 2.58489366448193, 3.03949868605546, 9.79202693710499, 140.189025593375 },
        { -0.30000382753223, -12.8341194418035, 17.8296646862525, 756.875695770193 },
        { -0.0117157384717799, 5.66169260025708, -7.74792929651684, -307.258754827103 },
        { 1.32101692707552, 9.12244029414334, 6.7347551893582, -961.656838651176 },
        { -1.27391203769561, -3.35554132288753, 0.3493420704134, -3.421536833111 },
        { 0.29560756680692, 3.07115524624411, 5.827164488293, -9.54982048358954 },
        { 0.0215295916220146, 0.30054637733164, -7.51402361191555, -127.843615586236 },
        { 1.65473433914191, -4.93206227030118, -30.0495089809424, 457.072691305915 },
        { 1.5393435919387, -0.877084835344845, -1.40468049280275, 38.2691856195171 },
        { -1.62437758159089, -2.41550745830894, -10.4696024147728, 71.2860640108494 },
        { -3.19286683781616, -0.30340423779288, -0.316111501726304, 104.616437632951 }
    };
    
    // We have the actual derivatives too, which we expect to be better than Fornbergs
    // So we define these here too

    vector<vector<double>> act_der = {
        { 1.21158951655157, 10.8875116049814, -35.9178834085914, -236.674781097529 },
        { 1.09085004307293, 11.0914295334206, 49.6796889215656, -1004.86316962461 },
        { -0.0935787053174586, -11.9348760855023, 46.7907095812802, 1008.00838101071 },
        { -0.842193654338596, 5.71024766614384, -11.1130765680727, -697.016939466085 },
        { 0.545253611780536, 2.91176339062732, -16.4183106806287, -52.0376335321454 },
        { 0.111486736514683, 12.6113132948914, 28.814407162849, -988.298435902323 },
        { -0.969148927003456, -0.066196622253277, 98.7825398776912, -498.141776467768 },
        { 1.92749363654414, -4.06547437117131, 67.7211387195838, 937.870694842906 },
        { 0.189945085368035, 12.294206214335, -29.0634000159769, -413.536089704494 },
        { -0.245374049466792, -10.2741714732946, -40.1887819110067, 22.31777436336 },
        { -0.0468855171793256, -8.71256345849655, 88.9028513624401, 709.87270356924 },
        { 1.6904830763928, -1.20659609345089, -34.3203334442766, -154.116757374445 },
        { 1.29568605898916, 7.62706609006378, -36.3983644028355, 137.998770768416 },
        { -0.303514063827696, -8.02885450785697, -35.4116370851457, -148.462713791342 },
        { -0.923923424750924, 3.69848861082895, 64.2165472698516, -957.347207270611 },
        { -0.432475147934399, -4.70830227291854, -17.8857472901093, -78.279503960007 },
        { 0.393785440500935, 5.47000179001202, -21.7711691915784, 121.895515245991 },
        { 0.206288811455618, 11.7701573967522, -34.6945848068096, -277.651358207407 },
        { -0.518668497696744, -3.333489263484, -15.444404957671, 21.2870043754433 },
        { -0.532031287123978, -3.12475029417214, -15.8317466352207, 36.6999885841963 },
        { -0.376930050154756, -5.85509787318969, -23.9699857399523, -138.617976448303 },
        { 1.40699979666044, 4.52414556776652, -20.120924117686, 107.473921126525 },
        { 0.676494724521009, -0.108582952169211, -32.2283080597495, -161.738342931552 },
        { -0.103046987893211, -12.3326760062058, 37.2403375442781, 1006.03638667734 },
        { 0.833689161519814, -5.59141364396234, -16.7282605555855, 623.082706126629 },
        { 0.885683507823483, -5.42866030480415, 26.1420212666358, 979.523868305897 },
        { -0.920847025073935, 3.89149066763942, 61.248812032798, -971.625972053372 },
        { 1.87576570883048, -6.24897029282644, 16.7481590093378, 936.568300338183 },
        { 0.92358119735608, -3.72040917708884, 63.8886247794099, 959.049223362592 },
        { 1.98998950891102, 1.61522219816047, 105.929208438714, 168.883112960017 },
        { 0.0944597038442665, 11.9757073535784, 45.902352154531, -1008.66793544248 },
        { -0.777262017601174, 3.91773331395273, -38.1599484483296, -156.775510722092 },
        { 1.17566018389698, 11.9628796473273, -22.1197031922992, -539.683687313521 },
        { 1.31287819045099, 7.02280857347798, -33.8421899349947, 156.93911404326 },
        { 0.0747777262540694, 10.8791676331259, 65.3324071764651, -950.338049458613 },
        { 1.27613716078293, 8.36271116988949, -38.728705009314, 96.4900163587773 },
        { -0.976908981345251, -0.84659689813977, 102.198510798502, -380.934495728811 },
        { -0.387485236755882, -5.60962732883914, -22.5598103104708, -128.413410984917 },
        { 0.405974097897088, 5.21337147820434, -20.3654535042625, 108.645176345156 },
        { 0.462034438643417, 4.20879417105232, -16.0809114427439, 43.862493282991 },
        { 1.14296272627977, 12.346408358231, 0.177843294821222, -816.394744514316 },
        { 0.491566371303712, 3.74805842934082, -15.2891755247542, 9.81822493632518 },
        { 0.250411334593573, 10.0715512144834, -40.2389439014152, 2.06880983930634 },
        { -0.0625974590212788, -10.0147334931953, 76.439485426722, 867.501816448262 },
        { 0.463119590368436, 4.19136952054175, -16.0339966756938, 42.6043479038701 },
        { 1.22757705294165, 10.2879973859885, -38.7807990278552, -124.50476894601 },
        { -0.80572152129487, 4.912262330062, -30.6859856923646, -376.626296640075 },
        { -0.6577630452412, -0.466611985796209, -29.1881530808044, 161.057453552093 },
        { -0.829186593079273, 5.50991219836211, -19.4439772949013, -583.157728705626 },
        { -0.751799162121505, 2.91261552213449, -40.1590926623421, -8.67685557345618 },
        { -0.438794704893315, -4.59678640048956, -17.4143158389072, -70.9159224174217 },
        { -0.32144766812631, -7.41855348075094, -32.6121872352529, -161.394061118842 },
        { -0.276413371582682, -9.03809820884115, -38.8391650611293, -97.2732011035598 },
        { 0.0470219820062949, 8.72468895590559, 88.8058695987122, -711.471137356482 },
        { -0.483912276075844, -3.86545662988452, -15.3979564944258, -18.6086156943461 },
        { -0.916692607242046, 4.13751108578498, 57.178330979337, -987.270976361419 },
        { -0.115944590259083, -12.7299902120822, 24.4406736711232, 973.348950565515 },
        { 1.97249757494534, -0.19723158852848, 100.487422171066, 448.519141065872 },
        { 1.12178727264116, 12.1486799622683, 18.9652305400009, -948.446435462095 },
        { 1.47628535664651, 3.32432598150143, -15.4415060400468, 27.3609042007943 },
        { 0.0690460728070796, 10.4892729342342, 70.6842419089335, -915.801880892209 },
        { -0.0646047561879912, -10.1664116002032, 74.6818385083388, 883.596972782418 },
        { 1.79192011222158, -5.07540795516513, -34.9709234738154, 263.868376629003 },
        { 1.67026194822142, -0.544973242414788, -31.0895951523097, -162.762864175309 },
        { 1.0449831458812, 7.82358327698808, 90.3755576403501, -687.227830850747 },
        { 1.66312066241141, -0.327103705577505, -29.9277876929808, -162.355033094752 },
        { 0.911904088009247, -4.39993709932731, 52.417710708948, 1000.16589924583 },
        { 1.7892697170719, -4.98181844997095, -35.6431104328852, 243.439846492017 },
        { -0.257644314163112, -9.78084182617149, -40.1074285864942, -33.6217555330013 },
        { -0.693533417307138, 0.680830222436794, -34.9125272537386, 151.299098168267 },
        { -0.585961502778545, -2.18719796156207, -19.5009197415822, 99.2668754149997 },
        { 1.40313571849982, 4.60270745671554, -20.544520538221, 111.764939736616 },
        { 1.07380526587664, 10.1007332308871, 66.3969061161282, -945.068086280396 },
        { -0.0824547131294182, -11.3523522282848, 57.8979050729595, 984.108949307779 },
        { 0.88212966363449, -5.51540651175804, 22.6841884796176, 966.068347744925 },
        { 1.6716299961237, -0.587657579618167, -31.3121974955939, -162.657440631114 },
        { 0.591719680623202, 2.07322641605038, -20.0913046965608, -105.777061914026 },
        { 0.0157911986362662, 5.67091590039564, 104.416490771198, -264.059961534296 },
        { 0.48398721534971, 3.86430277037719, -15.3965652061708, 18.5224691179283 },
        { 1.70240163005216, -1.62631297607294, -36.0837172208712, -140.61048493674 },
        { -0.476887872970988, -3.97414362176646, -15.5570531380264, -26.6928937029467 },
        { -0.160916761564189, -12.9277040775496, -13.3378705187714, 669.98919629096 },
        { 1.53871581427661, 2.36702870368854, -15.9727323683232, -44.4691814587668 },
        { 1.31468017647391, 6.96208088152284, -33.5583018892835, 158.121207274022 },
        { 0.846015111719803, -5.74754749172586, -8.38766392362975, 729.226481442513 },
        { -0.550313750771967, -2.8279931175868, -16.6965273969846, 57.9279794125431 },
        { 0.68749803026681, -0.47290878816836, -33.9831110294496, -156.412132385966 },
        { 1.1465878047206, 12.3417488816327, -2.73179616076299, -788.694927127467 },
        { -0.184282210854747, -12.4518944401306, -26.5817902492202, 463.059840169585 },
        { 0.171078178897851, 12.7591115929524, -19.6933764747571, -580.510698168963 },
        { 1.84773645484656, -6.37289706801967, -6.99773637501022, 743.437891356334 },
        { -0.124824364030686, -12.9091272906545, 15.965952897748, 933.240693371422 },
        { 1.38695679299381, 4.95048813249449, -22.4935949680439, 128.920381702128 },
        { -0.889027194136539, 5.33575329763218, 29.4354632764644, -990.072983930931 },
        { -0.606661846067897, -1.76059451328056, -21.7949108272171, 122.077308035906 },
        { 1.0993685075258, 11.4780637901204, 41.0897922530504, -1009.17262489811 },
        { 0.706871577140042, -1.15950175861728, -36.8229580510482, -133.609923136567 },
        { 1.58222842353253, 1.61393924951804, -19.0092257088344, -95.0272422862804 },
        { 1.73619749140369, -2.91367142930697, -39.6323190366537, -57.0715518975328 },
        { 0.759395782670583, -3.21707566709985, -39.94843053838, 47.5448857354185 }
    };

    // We can compute the 1st, 2nd and 3rd derivative based on Fornberg
    ds.compute_app_der(3);

    // Now lets rationalise the results
    cout << "i,act1,fd1,fb1,act2,fd2,fb2,act3,fd3,fb3" << endl;

    for(size_t i = 0; i < act_der.size(); i++) {

        // Check if the absolute difference between act_der and fd is larger than between act_der and Yder for each sample
        // where Yder is the Fornberg derivative approximation and fd is vanilla FD
    
        cout << i+1 << "," << act_der[i][0] << "," << fd[i][0] << "," << ds.Yder[0][i] << "," << act_der[i][1] << "," << fd[i][1] << "," << ds.Yder[1][i] << "," << act_der[i][2] << "," << fd[i][2] << "," << ds.Yder[2][i] << endl;

        //CHECK(abs(act_der[i][0] - fd[i][0]) > abs(act_der[i][0] - ds.Yder[0][i]));
        //CHECK(abs(act_der[i][1] - fd[i][1]) > abs(act_der[i][1] - ds.Yder[1][i]));
        //CHECK(abs(act_der[i][2] - fd[i][2]) > abs(act_der[i][2] - ds.Yder[2][i]));

    }

    // 2. Normalisation test

    // Read in the min-max normalisation from excel for validation
    // using =(A2-MIN(A$2:A$101))/(MAX(A$2:A$101)-MIN(A$2:A$101))
    // and filling right to build the normalisation of the different elements
    // =CONCAT("{ ",G2, ", ",H2, ", ",I2, ", ",J2, " },")
    // we then extract normalisation for y, yd, ydd, yddd to compare using
    
    DataSet ds2 = DataSet(fn);
    ds2.load();

    vector<vector<double>> norm = {
        { 0.736531280952898, 0.927137718743383, 0.0295622570556191, 0.382959110529865 },
        { 0.550522698604724, 0.935076341072244, 0.615172535079616, 0.00213637510014053 },
        { 0.0927385710738386, 0.0386512678248179, 0.595407768993206, 1 },
        { 0.520815852237398, 0.725584361361565, 0.199262745454751, 0.154748475480209 },
        { 0.56127559978744, 0.616638032185769, 0.162967327967289, 0.474491376114628 },
        { 0.12132225043739, 0.994246141679962, 0.472424053795104, 0.0103481982700815 },
        { 0.453937149058219, 0.50070462685128, 0.951106527334404, 0.253339113809523 },
        { 0.854513060346328, 0.345010834354039, 0.738601951879223, 0.965229849992463 },
        { 0.251999251011567, 0.981901011609186, 0.0764567637102857, 0.295281649712569 },
        { 0.33352844281457, 0.103303291396381, 0.00034318002660232, 0.511352425112065 },
        { 0.0291819467531294, 0.16409743711026, 0.883515274677249, 0.852201821964337 },
        { 0.997312765892648, 0.456308330874928, 0.0404917922432662, 0.423886535228616 },
        { 0.837536145875895, 0.800207017922346, 0.026275077279781, 0.568700276428431 },
        { 0.402391101380673, 0.190714553042802, 0.0330257086717255, 0.426689478329182 },
        { 0.465367673564619, 0.647265620684606, 0.714625515195689, 0.0256920015981162 },
        { 0.505717089543777, 0.319985237176362, 0.152927954916545, 0.461482196298343 },
        { 0.48022903454688, 0.716231474681738, 0.126346091225555, 0.560717227076263 },
        { 0.27753443063157, 0.961499540897322, 0.0379313756508602, 0.36264532758731 },
        { 0.550495435977553, 0.37350736413324, 0.169630241244673, 0.510841429824633 },
        { 0.556095669917158, 0.381633671885414, 0.166980268105186, 0.518482283155893 },
        { 0.467850172397108, 0.275339936840902, 0.111303029428774, 0.431569921538889 },
        { 0.923048285179322, 0.679408840285225, 0.13763613661145, 0.55356784678901 },
        { 0.588152639366539, 0.499054506787367, 0.0548042491706755, 0.420108200247878 },
        { 0.107656336928313, 0.0231647269547356, 0.530069513811744, 0.999022400901261 },
        { 0.527056552940054, 0.285605289799002, 0.160846825860677, 0.809176432974265 },
        { 0.488618926379869, 0.291941355010272, 0.454141097806206, 0.985879049712755 },
        { 0.466883003839468, 0.654779282918423, 0.694321945713961, 0.018613427716578 },
        { 0.890620981312891, 0.260006295462805, 0.389873594202283, 0.964584199205098 },
        { 0.465532410940448, 0.35844438713492, 0.712382054597797, 0.97572892194369 },
        { 0.842932563622877, 0.566163064439737, 1, 0.584010921383511 },
        { 0.0941053699547217, 0.969501698870614, 0.589330128874434, 0.00025019542329203 },
        { 0.56260547041101, 0.655800921670768, 0.0142233134906695, 0.422568481300953 },
        { 0.683069448587806, 0.969002310140783, 0.123961618307612, 0.232745071567371 },
        { 0.853869786030351, 0.776682984257102, 0.0437629802662856, 0.578089787443735 },
        { 0.0648371830497124, 0.926812883934642, 0.722259598877728, 0.0291667308323626 },
        { 0.817264237244892, 0.828846032164602, 0.0103322021105317, 0.548122671202103 },
        { 0.454394517747287, 0.470323271454913, 0.974476672377094, 0.31144360735553 },
        { 0.475700223040015, 0.284896222349364, 0.120950653804568, 0.436628746420491 },
        { 0.488675695248966, 0.706240734097167, 0.135963204562562, 0.55414848641193 },
        { 0.522802330677344, 0.667132059824799, 0.165275623122445, 0.522033032780153 },
        { 0.631238277136239, 0.983933265998583, 0.276508846483793, 0.0955679633206441 },
        { 0.538041362338049, 0.649195397389813, 0.170692233412129, 0.505155881821988 },
        { 0.340178225310735, 0.895371991104553, 0, 0.501314176454786 },
        { 0.048306836156528, 0.113403335848261, 0.798247959354578, 0.930345088442302 },
        { 0.523393776086717, 0.666453709859817, 0.165596587479584, 0.521409318113281 },
        { 0.758505247308859, 0.903798343918446, 0.00997580423789536, 0.438566421833584 },
        { 0.546235066123207, 0.69451841117459, 0.065355948310964, 0.313579359712961 },
        { 0.58770594824207, 0.485116265542535, 0.0756032736522243, 0.580131418560016 },
        { 0.530300335860366, 0.717785205936793, 0.142267424699497, 0.211193192353379 },
        { 0.573903954768162, 0.616671206072252, 0.000546297109149255, 0.495987105963201 },
        { 0.509532320759661, 0.32432660334099, 0.156153222826514, 0.465132628025102 },
        { 0.420355985859811, 0.214473863458491, 0.0521779645159299, 0.420278874972507 },
        { 0.372407977171707, 0.151424213830255, 0.00957649678042486, 0.452066235565064 },
        { 0.0293363426404612, 0.842938000225547, 0.882851780186998, 0.147582932156106 },
        { 0.534260350420489, 0.352797620534643, 0.169948015414364, 0.491063521965633 },
        { 0.469048019540234, 0.6643569752763, 0.666474011753702, 0.0108575524320999 },
        { 0.128652982501177, 0.00769709519481039, 0.442501437810001, 0.982817887763335 },
        { 0.84134125585687, 0.495603373042476, 0.962770369738374, 0.722638058604579 },
        { 0.597492154006827, 0.976235605124652, 0.405041546284649, 0.0301044820757944 },
        { 0.958088238813167, 0.632699290855051, 0.169650074002888, 0.513852513018238 },
        { 0.0568885298045537, 0.911634097124588, 0.75887383150492, 0.0462877370609752 },
        { 0.0509353303394478, 0.107498434713237, 0.786223131167017, 0.938324122692084 },
        { 0.956180172585115, 0.305693637666494, 0.036040822458652, 0.631099042573801 },
        { 0.999596560125509, 0.48206562440337, 0.0625946801859766, 0.419600302721203 },
        { 0.493296698302346, 0.807857525850036, 0.893590699825151, 0.159601341230315 },
        { 1, 0.49054738950933, 0.0705431110905789, 0.419802481444561 },
        { 0.471701766158616, 0.331990040634555, 0.633904534790546, 0.99611215763885 },
        { 0.957909744267708, 0.309337121794488, 0.0314420986716424, 0.620971775820274 },
        { 0.349494955353583, 0.122508850133256, 0.000899753556540578, 0.483620888015245 },
        { 0.587288352085278, 0.529786738634717, 0.0364403364371889, 0.575293798457882 },
        { 0.574798667892325, 0.418133031893152, 0.141877856618015, 0.549499275011126 },
        { 0.920760101583794, 0.68246729213682, 0.134738128982884, 0.555695082073063 },
        { 0.527033035519662, 0.896508060938122, 0.729542299812375, 0.0317792694011772 },
        { 0.0759157267245432, 0.0613291997526143, 0.671396931569696, 0.988152063878787 },
        { 0.49114296083563, 0.288564283750579, 0.43048455750205, 0.979208592018796 },
        { 0.999496027480729, 0.480403902773452, 0.0610717605915207, 0.419652565529491 },
        { 0.576390629457741, 0.583993387347993, 0.137838775973383, 0.44785052027449 },
        { 0, 0.724053156939315, 0.989650839507118, 0.369383144686171 },
        { 0.534297935229306, 0.653720845095262, 0.169957533823352, 0.509470935432005 },
        { 0.995124725554019, 0.439968552211587, 0.0284277157097457, 0.43058215272558 },
        { 0.530687375928108, 0.348566384040555, 0.168859565974089, 0.487055811212399 },
        { 0.20435123042137, 0, 0.184041960933089, 0.832429918916741 },
        { 0.981164751024069, 0.595431250701977, 0.166015723292617, 0.478243370631336 },
        { 0.85550488745823, 0.77431882621065, 0.0457051820466748, 0.578675799917231 },
        { 0.51797444975764, 0.27952692454866, 0.217908480526376, 0.861796289598417 },
        { 0.563160162344376, 0.393186570477127, 0.161063926221411, 0.52900587561793 },
        { 0.587739789416054, 0.484871128019343, 0.0427988776748607, 0.422748622961548 },
        { 0.637045572256264, 0.983751870349621, 0.25660273554922, 0.109299907705263 },
        { 0.242905947130656, 0.0185234963929533, 0.0934345370968033, 0.729846484155445 },
        { 0.221293960913556, 1, 0.140561176273537, 0.212505434799104 },
        { 0.913777787885561, 0.25518176692712, 0.227417580329357, 0.868841472887468 },
        { 0.143432297675505, 0.00072320318459849, 0.384522181469298, 0.962934566892969 },
        { 0.910737137067942, 0.696006559916841, 0.121403661805058, 0.564199743734689 },
        { 0.486283173791975, 0.71100511676716, 0.476672969196116, 0.00946848146558565 },
        { 0.580111655087053, 0.434740907846083, 0.126183664354458, 0.560807349276196 },
        { 0.563003851013559, 0.950128197310844, 0.556405310270433, 0 },
        { 0.585699349838534, 0.458141735818449, 0.023370247182287, 0.434052620561469 },
        { 0.992466264618484, 0.566113118636455, 0.145241749674579, 0.453179650182147 },
        { 0.985213760534866, 0.389851072888823, 0.00415018494144949, 0.471995854715883 },
        { 0.570882509272288, 0.378039401030201, 0.00198752846214529, 0.52385854692174 }
    };

    ds2.normalise();

    for(size_t i = 0; i < norm.size(); i++) {
        CHECK( ds2.y[i] == doctest::Approx(norm[i][0]).epsilon(1e-15) );
        CHECK( ds2.Yder[0][i] == doctest::Approx(norm[i][1]).epsilon(1e-15) );
        CHECK( ds2.Yder[1][i] == doctest::Approx(norm[i][2]).epsilon(1e-15) );
        CHECK( ds2.Yder[2][i] == doctest::Approx(norm[i][3]).epsilon(1e-15) );
    }

}